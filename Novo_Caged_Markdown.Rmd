---
title: "mercado de trabalho"
output: 
  html_document: 
    theme: journal
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r carregamento, include=FALSE}
library(tidyverse)
library(lubridate)
library(knitr)

readRDS(file = "D:/Users/humberto.serna/Documents/CSV_Data/Novo_Caged_microdados_2020_secoes_CNAE23_B_C.RDATA")



source('D:/Users/humberto.serna/Documents/CSV_Data/RAIS_CAGED/CNAE_2_3.R')

# CUIDADO ! ATENÇÃO! OS MICRODADOS ESTÃO COM SUBCLASSE SEM '0' NA FRENTE. HÁ SUBCLASSES COM 7 E OUTRA COM 6 DÍGITOS....

#___Grupo	denominação_______________________________________________________________
#                                                                                   |
#		05.0	Extração de carvão mineral													                      |
#		07.1	Extração de minério de ferro  												                    |
#		07.2	Extração de minerais metálicos não ferrosos									              |
#		08.1	Extração de pedra, areia e argila											                    |
#		08.9	Extração de outros minerais não metálicos									                |
#		09.9	Atividades de apoio à extração de minerais, exceto petróleo e gás natural	|
#___________________________________________________________________________________|

# _____ estabelecimentos ----
# arquivos <- c(
#   "CAGEDESTAB202001.txt",
#   "CAGEDESTAB202002.txt",
#   "CAGEDESTAB202003.txt",
#   "CAGEDESTAB202004.txt",
#   "CAGEDESTAB202005.txt",
#   "CAGEDESTAB202006.txt",
#   "CAGEDESTAB202007.txt",
#   "CAGEDESTAB202008.txt",
#   "CAGEDESTAB202009.txt",
#   "CAGEDESTAB202010.txt",
#   "CAGEDESTAB202011.txt",
#   "CAGEDESTAB202012.txt"
#   )
# 
# lista <- list()
# for (i in 1:length(arquivos)) {
# lista[[i]] <-
#   read.table(
#     paste('./CSV_Data/RAIS_CAGED/Novo_Caged/', arquivos[[i]], sep = ""),
#     header = TRUE,
#     sep = ";",
#     dec = ".",
#     colClasses = c("character", "character", "character", "character", "character", "integer", "integer", "integer", "character", "integer", "character", "character", "character"),
#     stringsAsFactors = FALSE,
#     encoding = "UTF-8"
#   )
# }
# 
# estabelecimentos <- 
#   do.call("rbind", lista)
# rm(lista)

# _______________________________________________________________________
#   O número de estabelecimentos que apresentam declarações à Rais       | 
#   difere ano a ano, o que dificulta discriminar se a variação do       |
#   emprego se deve a um real aumento ou redução decorrente da situação  | 
#   do mercado de trabalho e/ou a um melhor desempenho na declaração.    |
#   Opte por uma amostra longitudinal de empresas que declaram os dados. |
# _______________________________________________________________________|


# _____ movimentação ----

arquivos <- c(
  "CAGEDMOV202001.txt",
  "CAGEDMOV202002.txt",
  "CAGEDMOV202003.txt",
  "CAGEDMOV202004.txt",
  "CAGEDMOV202005.txt",
  "CAGEDMOV202006.txt",
  "CAGEDMOV202007.txt",
  "CAGEDMOV202008.txt",
  "CAGEDMOV202009.txt",
  "CAGEDMOV202010.txt",
  "CAGEDMOV202011.txt",
  "CAGEDMOV202012.txt"
  )


lista <- list()
for (i in 1:length(arquivos)) {
  lista[[i]] <-
    read.table(
      paste('D:/Users/humberto.serna/Documents/CSV_Data/RAIS_CAGED/Novo_Caged/', arquivos[[i]], sep = ""),
      header = TRUE,
      sep = ";",
      dec = ".",
      quote = "",
      colClasses = c(
        "character",	#	competência
        "NULL",	      #	região
        "character",	#	uf
        "character",	#	município
        "character",	#	seção
        "integer", 	  #	subclasse
        "integer",	  #	saldomovimentação
        "character",	#	cbo2002ocupação
        "character",	#	categoria
        "character",	#	graudeinstrução
        "NULL",	      #	idade
        "NULL",	      #	horascontratuais
        "NULL",	#	raçacor
        "NULL",	#	sexo
        "NULL",	#	tipoempregador
        "NULL",	#	tipoestabelecimento
        "NULL",	#	tipomovimentação
        "NULL",	#	tipodedeficiência
        "NULL",	#	indtrabintermitente
        "NULL",	#	indtrabparcial
        "numeric",	#	salário
        "NULL",	#	tamestabjan
        "NULL",	#	indicadoraprendiz
        "NULL"	#	fonte
      ),
      stringsAsFactors = FALSE,
      encoding = "UTF-8"
      )
}

movimentacao <- 
  do.call("rbind", lista)
rm(lista)


# ____ impondo trimestre
movimentacao$trimestre <-
  lubridate::quarter(
    lubridate::ymd(
      paste(str_extract(movimentacao$competência, pattern = "^...."), str_extract(movimentacao$competência, pattern = "..$"), "1", sep = "_")
    ), with_year = TRUE)

# ____ impondo semestre
movimentacao$semestre <-
  lubridate::semester(
    lubridate::ymd(
      paste(str_extract(movimentacao$competência, pattern = "^...."), str_extract(movimentacao$competência, pattern = "..$"), "1", sep = "_")
      ), with_year = TRUE)
    
# ____ impondo mês.ANO
movimentacao$competência <-
  lubridate::ymd(
    paste(str_extract(movimentacao$competência, pattern = "^...."), str_extract(movimentacao$competência, pattern = "..$"), "1", sep = "_")
  )

# _____ Geocod  ----
geocod <- 
  read.table(file = "D:/Users/humberto.serna/Documents/CSV_Data/GeoCodigos_IBGE.csv", sep = ";", stringsAsFactors = FALSE, header = TRUE, 
             colClasses = "character", encoding = 'iso-8859-1', quote = "") %>% as_tibble()
geocod$GEOCOD <- 
  str_extract(geocod$GEOCOD, "......")

# ______________________________________________________________________________________________----
```

```{r EXTRATIVA MINERAL: subclasses alvo, include=FALSE}

# _____ lista subclasses_alvo na seção B (Extrativa Mineral - Exceto petróleo & Gás) ----
subclasses_alvo_SECAO_B <-                    
    c(#subclasse  denominação
      "500301",	#Extração de carvão mineral
      "500302",	#Beneficiamento de carvão mineral
      "710301",	#Extração de minério de ferro
      "710302",	#Pelotização, sinterização e outros beneficiamentos de minério de ferro
      "721901",	#Extração de minério de alumínio
      "721902",	#Beneficiamento de minério de alumínio
      "722701",	#Extração de minério de estanho
      "722702",	#Beneficiamento de minério de estanho
      "723501",	#Extração de minério de manganês
      "723502",	#Beneficiamento de minério de manganês
      "724301",	#Extração de minério de metais preciosos
      "724302",	#Beneficiamento de minério de metais preciosos
      "725100",	#Extração de minerais radioativos
      "729401",	#Extração de minérios de nióbio e titânio
      "729402",	#Extração de minério de tungstênio
      "729403",	#Extração de minério de níquel
      "729404",	#Extração de minérios de cobre, chumbo, zinco e outros minerais metálicos não ferrosos não especificados anteriormente
      "729405",	#Beneficiamento de minérios de cobre, chumbo, zinco e outros minerais metálicos não ferrosos não especificados anteriormente
      "810001",	#Extração de ardósia e beneficiamento associado
      "810002",	#Extração de granito e beneficiamento associado
      "810003",	#Extração de mármore e beneficiamento associado
      "810004",	#Extração de calcário e dolomita e beneficiamento associado
      "810005",	#Extração de gesso e caulim
      "810006",	#Extração de areia, cascalho ou pedregulho e beneficiamento associado
      "810007",	#Extração de argila e beneficiamento associado
      "810008",	#Extração de saibro e beneficiamento associado
      "810009",	#Extração de basalto e beneficiamento associado
      "810010",	#Beneficiamento de gesso e caulim associado à extração
      "810099",	#Extração e britamento de pedras e outros materiais para construção e beneficiamento associado
      "891600",	#Extração de minerais para fabricação de adubos, fertilizantes e outros produtos químicos
      "892401",	#Extração de sal marinho
      "892402",	#Extração de salgema
      "892403",	#Refino e outros tratamentos do sal
      "893200",	#Extração de gemas (pedras preciosas e semipreciosas)
      "899101",	#Extração de grafita
      "899102",	#Extração de quartzo
      "899103",	#Extração de amianto
      "899199",	#Extração de outros minerais não metálicos não especificados anteriormente
      "990401",	#Atividades de apoio à extração de minério de ferro
      "990402",	#Atividades de apoio à extração de minerais metálicos não ferrosos
      "990403"	#Atividades de apoio à extração de minerais não metálicos
  )

# _____ delimitando df por subclasses alvo

#         df <- estabelecimentos[estabelecimentos$subclasse %in% subclasses_alvo, ]
          df_Extrativa <- movimentacao[movimentacao$subclasse %in% subclasses_alvo_SECAO_B, ]
          

# _____ junção coluna de municípios

df_Extrativa <- 
  left_join(df_Extrativa, geocod[, c("UF_sigla", "GEOCOD", "Município")], by = c("município" = "GEOCOD"))

# _____ junção Grupo - Subclasse
df_Extrativa <- 
  left_join(df_Extrativa, cnae[,c("grupo", "classe", "subclasse", "denominação")], by = c("subclasse" = "subclasse"))   


```

```{r Extrativa_BR_Grupo_semestre, echo=FALSE, message=FALSE}

df_Extrativa_BR_Grupo_semestre <-
  left_join(
    summarise(
      group_by(df_Extrativa[df_Extrativa$semestre %in% c('2020.1', '2020.2'), c(
        "uf",
        "município",
        "seção",
        "grupo",
        "classe",
        "subclasse",
        "saldomovimentação",
        "salário",
        "semestre",
        "trimestre",
        'competência'
      )], grupo, semestre),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe == 0 &
           cnae$subclasse == 0, c("grupo", "denominação")],
    by = "grupo"
  )[, c(
    "denominação",
    "semestre",
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(denominação, semestre) #%>% kable()

```

```{r Extrativa_UF_Grupo_Semestre, echo=FALSE, message=FALSE}

df_Extrativa_UF_Grupo_Semestre <-
  left_join(
    summarise(
      group_by(df_Extrativa[df_Extrativa$semestre %in% c("2020.2"), c(
        "competência",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], grupo, UF_sigla, semestre),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe == 0 &
           cnae$subclasse == 0, c("grupo", "denominação")],
    by = "grupo"
  )[, c(
    "denominação",
    'UF_sigla',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```

```{r Extrativa_UF_Subclasse_Semestre, echo=FALSE, message=FALSE}

df_Extrativa_UF_Subclasse_Semestre <-
  left_join(
    summarise(
      group_by(df_Extrativa[df_Extrativa$semestre %in% c("2020.2"), c(
        "competência",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], subclasse, UF_sigla, semestre),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe != 0 &
           cnae$subclasse != 0, c("subclasse", "denominação")],
    by = "subclasse"
  )[, c(
    "denominação",
    'UF_sigla',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```

```{r Extrativa_Município_Grupo_Semestre, echo=FALSE, message=FALSE}

df_Extrativa_Município_Grupo_Semestre <-
  left_join(
    summarise(
      group_by(df_Extrativa[df_Extrativa$semestre %in% c("2020.2"), c(
        "competência",
        "Município",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], grupo, Município),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe == 0 &
           cnae$subclasse == 0, c("grupo", "denominação")],
    by = "grupo"
  )[, c(
    "denominação",
    'Município',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```
 
```{r Extrativa_Município_Subclasse_Semestre, echo=FALSE, message=FALSE}

df_Extrativa_Município_Subclasse_Semestre <-
  left_join(
    summarise(
      group_by(df_Extrativa[df_Extrativa$semestre %in% c("2020.2"), c(
        "competência",
        "Município",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], subclasse, Município),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe != 0 &
           cnae$subclasse != 0, c("subclasse", "denominação")],
    by = "subclasse"
  )[, c(
    "denominação",
    'Município',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```
 





 UFs e Grupos CNAEs com MAIS contratações 
 
 `r head(df_Extrativa_UF_Grupo_Semestre)`
 
 
 UFs e Grupos CNAEs com MENOS contratações 
 
 `r tail(df_Extrativa_UF_Grupo_Semestre)`

UF's
		mais contrataram:
		menos contrataram:


* subclasses 
		mais contrataram: **Extração de minério de ferro**, **Extração de calcário e dolomita e beneficiamento associado** e **Extração de minério de metais preciosos **
		menos contrataram: **Extração de granito e beneficiamento associado**, **Extração de outros minerais não metálicos não especificados anteriormente** e **Atividades de apoio à extração de minerais metálicos não ferrosos**





```{r INDÚSTRIA DE TRANSFORMAÇÃO (MINERAL): subclasses alvo, include=FALSE}

# _____ lista subclasses_alvo na seção B (Extrativa Mineral - Exceto petróleo & Gás) ----
subclasses_alvo_SECAO_B <-                    
    c(#subclasse  denominação
      "500301",	#Extração de carvão mineral
      "500302",	#Beneficiamento de carvão mineral
      "710301",	#Extração de minério de ferro
      "710302",	#Pelotização, sinterização e outros beneficiamentos de minério de ferro
      "721901",	#Extração de minério de alumínio
      "721902",	#Beneficiamento de minério de alumínio
      "722701",	#Extração de minério de estanho
      "722702",	#Beneficiamento de minério de estanho
      "723501",	#Extração de minério de manganês
      "723502",	#Beneficiamento de minério de manganês
      "724301",	#Extração de minério de metais preciosos
      "724302",	#Beneficiamento de minério de metais preciosos
      "725100",	#Extração de minerais radioativos
      "729401",	#Extração de minérios de nióbio e titânio
      "729402",	#Extração de minério de tungstênio
      "729403",	#Extração de minério de níquel
      "729404",	#Extração de minérios de cobre, chumbo, zinco e outros minerais metálicos não ferrosos não especificados anteriormente
      "729405",	#Beneficiamento de minérios de cobre, chumbo, zinco e outros minerais metálicos não ferrosos não especificados anteriormente
      "810001",	#Extração de ardósia e beneficiamento associado
      "810002",	#Extração de granito e beneficiamento associado
      "810003",	#Extração de mármore e beneficiamento associado
      "810004",	#Extração de calcário e dolomita e beneficiamento associado
      "810005",	#Extração de gesso e caulim
      "810006",	#Extração de areia, cascalho ou pedregulho e beneficiamento associado
      "810007",	#Extração de argila e beneficiamento associado
      "810008",	#Extração de saibro e beneficiamento associado
      "810009",	#Extração de basalto e beneficiamento associado
      "810010",	#Beneficiamento de gesso e caulim associado à extração
      "810099",	#Extração e britamento de pedras e outros materiais para construção e beneficiamento associado
      "891600",	#Extração de minerais para fabricação de adubos, fertilizantes e outros produtos químicos
      "892401",	#Extração de sal marinho
      "892402",	#Extração de salgema
      "892403",	#Refino e outros tratamentos do sal
      "893200",	#Extração de gemas (pedras preciosas e semipreciosas)
      "899101",	#Extração de grafita
      "899102",	#Extração de quartzo
      "899103",	#Extração de amianto
      "899199",	#Extração de outros minerais não metálicos não especificados anteriormente
      "990401",	#Atividades de apoio à extração de minério de ferro
      "990402",	#Atividades de apoio à extração de minerais metálicos não ferrosos
      "990403"	#Atividades de apoio à extração de minerais não metálicos
  )

# _____ delimitando df por subclasses alvo

#         df <- estabelecimentos[estabelecimentos$subclasse %in% subclasses_alvo, ]
          df_Transformação <- movimentacao[movimentacao$subclasse %in% subclasses_alvo_SECAO_B, ]
          

# _____ junção coluna de municípios

df_Transformação <- 
  left_join(df_Transformação, geocod[, c("UF_sigla", "GEOCOD", "Município")], by = c("município" = "GEOCOD"))

# _____ junção Grupo - Subclasse
df_Transformação <- 
  left_join(df_Transformação, cnae[,c("grupo", "classe", "subclasse", "denominação")], by = c("subclasse" = "subclasse"))   


```

```{r Transformação_BR_Grupo_semestre, echo=FALSE, message=FALSE}

df_Transformação_BR_Grupo_semestre <-
  left_join(
    summarise(
      group_by(df_Transformação[df_Transformação$semestre %in% c('2020.1', '2020.2'), c(
        "uf",
        "município",
        "seção",
        "grupo",
        "classe",
        "subclasse",
        "saldomovimentação",
        "salário",
        "semestre",
        "trimestre",
        'competência'
      )], grupo, semestre),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe == 0 &
           cnae$subclasse == 0, c("grupo", "denominação")],
    by = "grupo"
  )[, c(
    "denominação",
    "semestre",
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(denominação, semestre) #%>% kable()

```

```{r Transformação_UF_Grupo_Semestre, echo=FALSE, message=FALSE}

df_Transformação_UF_grupo_Semestre <-
  left_join(
    summarise(
      group_by(df_Transformação[df_Transformação$semestre %in% c("2020.2"), c(
        "competência",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], grupo, UF_sigla, semestre),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe == 0 &
           cnae$subclasse == 0, c("grupo", "denominação")],
    by = "grupo"
  )[, c(
    "denominação",
    'UF_sigla',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```

```{r Transformação_UF_Subclasse_Semestre, echo=FALSE, message=FALSE}

df_Transformação_UF_Subclasse_Semestre <-
  left_join(
    summarise(
      group_by(df_Transformação[df_Transformação$semestre %in% c("2020.2"), c(
        "competência",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], subclasse, UF_sigla, semestre),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe != 0 &
           cnae$subclasse != 0, c("subclasse", "denominação")],
    by = "subclasse"
  )[, c(
    "denominação",
    'UF_sigla',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```

```{r Transformação_Município_Grupo_Semestre, echo=FALSE, message=FALSE}

df_Transformação_Município_Grupo_Semestre <-
  left_join(
    summarise(
      group_by(df_Transformação[df_Transformação$semestre %in% c("2020.2"), c(
        "competência",
        "Município",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], grupo, Município),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe == 0 &
           cnae$subclasse == 0, c("grupo", "denominação")],
    by = "grupo"
  )[, c(
    "denominação",
    'Município',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```
 
```{r Transformação_Município_Subclasse_Semestre, echo=FALSE, message=FALSE}

df_Transformação_Município_Subclasse_Semestre <-
  left_join(
    summarise(
      group_by(df_Transformação[df_Transformação$semestre %in% c("2020.2"), c(
        "competência",
        "Município",
        "grupo",
        "subclasse",
        "saldomovimentação",
        "salário",
        "UF_sigla",
        "semestre",
        "trimestre"
      )], subclasse, Município),
      "Saldo_da_Movimentação" = sum(saldomovimentação),
      "salário_mediana" = round(median(salário), 1),
      "salário_medio" = round(mean(salário), 1)
    ),
    cnae[cnae$grupo != 0 &
           cnae$classe != 0 &
           cnae$subclasse != 0, c("subclasse", "denominação")],
    by = "subclasse"
  )[, c(
    "denominação",
    'Município',
    "Saldo_da_Movimentação",
    "salário_mediana",
    "salário_medio"
  )] %>% arrange(desc(Saldo_da_Movimentação))

```
 

